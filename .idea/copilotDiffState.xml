<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/heypudu/heypudu/features/onboarding/viewmodel/CreateProfileViewModel.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/heypudu/heypudu/features/onboarding/viewmodel/CreateProfileViewModel.kt" />
              <option name="originalContent" value="package com.heypudu.heypudu.features.onboarding.viewmodel&#10;&#10;import android.net.Uri&#10;import android.util.Patterns&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.setValue&#10;import androidx.lifecycle.ViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.firestore.FirebaseFirestore&#10;import kotlinx.coroutines.flow.MutableSharedFlow&#10;import kotlinx.coroutines.flow.asSharedFlow&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.tasks.await&#10;import java.io.File&#10;&#10;data class CreateProfileUiState(&#10;    val username: String = &quot;&quot;,&#10;    val password: String = &quot;&quot;,&#10;    val email: String = &quot;&quot;,&#10;    val isUsernameError: Boolean = false,&#10;    val isPasswordError: Boolean = false,&#10;    val isEmailError: Boolean = false,&#10;    val isLoading: Boolean = false,&#10;    val showDialog: Boolean = false,&#10;    val dialogMessage: String = &quot;&quot;&#10;)&#10;&#10;sealed class NavigationEvent {&#10;    object NavigateToEmailVerification : NavigationEvent()&#10;}&#10;&#10;class CreateProfileViewModel : ViewModel() {&#10;&#10;    var uiState by mutableStateOf(CreateProfileUiState())&#10;        private set&#10;&#10;    fun dismissDialog() {&#10;        uiState = uiState.copy(showDialog = false, dialogMessage = &quot;&quot;)&#10;    }&#10;&#10;&#10;    private val _navigationEvent = MutableSharedFlow&lt;NavigationEvent&gt;()&#10;    val navigationEvent = _navigationEvent.asSharedFlow()&#10;&#10;    private val auth: FirebaseAuth = FirebaseAuth.getInstance()&#10;    private val firestore: FirebaseFirestore = FirebaseFirestore.getInstance()&#10;&#10;    fun onUsernameChange(newUsername: String) {&#10;        val maxLength = 12&#10;        val isError = newUsername.isBlank()&#10;        if (newUsername.length &lt;= maxLength) {&#10;            uiState = uiState.copy(username = newUsername, isUsernameError = isError)&#10;        }&#10;    }&#10;&#10;    fun onPasswordChange(newPassword: String) {&#10;        val isError = newPassword.isNotEmpty() &amp;&amp; (newPassword.length &lt; 6 || newPassword.length &gt; 12)&#10;        uiState = uiState.copy(password = newPassword, isPasswordError = isError)&#10;    }&#10;&#10;    fun onEmailChange(newEmail: String) {&#10;        val isError = newEmail.isNotEmpty() &amp;&amp; !Patterns.EMAIL_ADDRESS.matcher(newEmail).matches()&#10;        uiState = uiState.copy(email = newEmail, isEmailError = isError)&#10;    }&#10;&#10;    fun onSaveProfileClick(imageUri: Uri?) {&#10;        if (uiState.isLoading) return&#10;&#10;        if (uiState.username.isBlank() || uiState.password.isBlank() || uiState.email.isBlank() || uiState.isPasswordError || uiState.isEmailError) {&#10;            println(&quot;Error: Campos inválidos.&quot;)&#10;            uiState = uiState.copy(&#10;                isUsernameError = uiState.username.isBlank(),&#10;                isPasswordError = uiState.password.isBlank() || uiState.isPasswordError,&#10;                isEmailError = uiState.email.isBlank() || uiState.isEmailError&#10;            )&#10;            return&#10;        }&#10;&#10;        viewModelScope.launch {&#10;            try {&#10;                uiState = uiState.copy(isLoading = true)&#10;&#10;                // Cerrar sesión antes de crear un nuevo usuario&#10;                auth.signOut()&#10;&#10;                // 1. Crear usuario en Firebase Auth con el CORREO REAL&#10;                val authResult = auth.createUserWithEmailAndPassword(uiState.email, uiState.password).await()&#10;&#10;                val firebaseUser = authResult.user&#10;                    ?: throw IllegalStateException(&quot;El usuario de Firebase es nulo después de la creación.&quot;)&#10;&#10;                // 2. Enviar el correo de verificación&#10;                firebaseUser.sendEmailVerification().await()&#10;&#10;                var photoUrl: String? = null&#10;                // Subir imagen a Firebase Storage si la URI no es nula y es válida&#10;                println(&quot;[DEBUG] Usuario autenticado: ${firebaseUser.uid}&quot;)&#10;                println(&quot;[DEBUG] URI: $imageUri, scheme: ${imageUri?.scheme}&quot;)&#10;                if (imageUri != null) {&#10;                    try {&#10;                        photoUrl = uploadProfileImage(imageUri, firebaseUser.uid)&#10;                        println(&quot;[DEBUG] URL de imagen subida: $photoUrl&quot;)&#10;                    } catch (e: Exception) {&#10;                        println(&quot;[ERROR] Error al subir la imagen: ${e.message}&quot;)&#10;                        photoUrl = &quot;&quot;&#10;                    }&#10;                } else {&#10;                    println(&quot;[ERROR] No se seleccionó imagen de perfil.&quot;)&#10;                }&#10;                // 3. Guardar los datos del perfil en Firestore&#10;                val userProfileData = hashMapOf(&#10;                    &quot;username&quot; to uiState.username,&#10;                    &quot;email&quot; to uiState.email,&#10;                    &quot;createdAt&quot; to System.currentTimeMillis(),&#10;                    &quot;isEmailVerified&quot; to false,&#10;                    &quot;photoUrl&quot; to (photoUrl ?: &quot;&quot;)&#10;                )&#10;&#10;                firestore.collection(&quot;users&quot;).document(firebaseUser.uid)&#10;                    .set(userProfileData)&#10;                    .await()&#10;&#10;                uiState = uiState.copy(isLoading = false)&#10;                &#10;                // 4. Navegar a una pantalla que diga &quot;Revisa tu correo para verificar la cuenta&quot;&#10;                _navigationEvent.emit(NavigationEvent.NavigateToEmailVerification)&#10;&#10;            } catch (e: Exception) {&#10;                uiState = uiState.copy(isLoading = false)&#10;                val errorMessage = when (e) {&#10;                    is com.google.firebase.auth.FirebaseAuthUserCollisionException -&gt;&#10;                        &quot;Ya existe una cuenta con este correo electrónico.&quot;&#10;                    is com.google.firebase.auth.FirebaseAuthWeakPasswordException -&gt;&#10;                        &quot;La contraseña es demasiado débil. Debe tener al menos 6 caracteres.&quot;&#10;                    else -&gt;&#10;                        &quot;Ocurrió un error inesperado: ${e.message}&quot;&#10;                }&#10;                uiState = uiState.copy(showDialog = true, dialogMessage = errorMessage)&#10;            }&#10;        }&#10;    }&#10;&#10;    suspend fun uploadProfileImage(imageUri: Uri, userId: String): String? {&#10;        val storageRef = com.google.firebase.storage.FirebaseStorage.getInstance().reference&#10;        val imageRef = storageRef.child(&quot;profile_images/$userId.jpg&quot;)&#10;        imageRef.putFile(imageUri).await() // Subir la imagen primero&#10;        return imageRef.downloadUrl.await().toString()&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.heypudu.heypudu.features.onboarding.viewmodel&#10;&#10;import android.net.Uri&#10;import android.util.Patterns&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.setValue&#10;import androidx.lifecycle.ViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.google.firebase.auth.FirebaseAuth&#10;import com.google.firebase.firestore.FirebaseFirestore&#10;import kotlinx.coroutines.flow.MutableSharedFlow&#10;import kotlinx.coroutines.flow.asSharedFlow&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.tasks.await&#10;import java.io.File&#10;&#10;data class CreateProfileUiState(&#10;    val username: String = &quot;&quot;,&#10;    val password: String = &quot;&quot;,&#10;    val email: String = &quot;&quot;,&#10;    val isUsernameError: Boolean = false,&#10;    val isPasswordError: Boolean = false,&#10;    val isEmailError: Boolean = false,&#10;    val isLoading: Boolean = false,&#10;    val showDialog: Boolean = false,&#10;    val dialogMessage: String = &quot;&quot;&#10;)&#10;&#10;sealed class NavigationEvent {&#10;    object NavigateToEmailVerification : NavigationEvent()&#10;}&#10;&#10;class CreateProfileViewModel : ViewModel() {&#10;&#10;    var uiState by mutableStateOf(CreateProfileUiState())&#10;        private set&#10;&#10;    fun dismissDialog() {&#10;        uiState = uiState.copy(showDialog = false, dialogMessage = &quot;&quot;)&#10;    }&#10;&#10;&#10;    private val _navigationEvent = MutableSharedFlow&lt;NavigationEvent&gt;()&#10;    val navigationEvent = _navigationEvent.asSharedFlow()&#10;&#10;    private val auth: FirebaseAuth = FirebaseAuth.getInstance()&#10;    private val firestore: FirebaseFirestore = FirebaseFirestore.getInstance()&#10;&#10;    fun onUsernameChange(newUsername: String) {&#10;        val maxLength = 12&#10;        val isError = newUsername.isBlank()&#10;        if (newUsername.length &lt;= maxLength) {&#10;            uiState = uiState.copy(username = newUsername, isUsernameError = isError)&#10;        }&#10;    }&#10;&#10;    fun onPasswordChange(newPassword: String) {&#10;        val isError = newPassword.isNotEmpty() &amp;&amp; (newPassword.length &lt; 6 || newPassword.length &gt; 12)&#10;        uiState = uiState.copy(password = newPassword, isPasswordError = isError)&#10;    }&#10;&#10;    fun onEmailChange(newEmail: String) {&#10;        val isError = newEmail.isNotEmpty() &amp;&amp; !Patterns.EMAIL_ADDRESS.matcher(newEmail).matches()&#10;        uiState = uiState.copy(email = newEmail, isEmailError = isError)&#10;    }&#10;&#10;    fun onSaveProfileClick(imageUri: Uri?) {&#10;        if (uiState.isLoading) return&#10;&#10;        if (uiState.username.isBlank() || uiState.password.isBlank() || uiState.email.isBlank() || uiState.isPasswordError || uiState.isEmailError) {&#10;            println(&quot;Error: Campos inválidos.&quot;)&#10;            uiState = uiState.copy(&#10;                isUsernameError = uiState.username.isBlank(),&#10;                isPasswordError = uiState.password.isBlank() || uiState.isPasswordError,&#10;                isEmailError = uiState.email.isBlank() || uiState.isEmailError&#10;            )&#10;            return&#10;        }&#10;&#10;        viewModelScope.launch {&#10;            try {&#10;                uiState = uiState.copy(isLoading = true)&#10;&#10;                // Cerrar sesión antes de crear un nuevo usuario&#10;                auth.signOut()&#10;&#10;                // 1. Crear usuario en Firebase Auth con el CORREO REAL&#10;                val authResult = auth.createUserWithEmailAndPassword(uiState.email, uiState.password).await()&#10;&#10;                val firebaseUser = authResult.user&#10;                    ?: throw IllegalStateException(&quot;El usuario de Firebase es nulo después de la creación.&quot;)&#10;&#10;                // 2. Enviar el correo de verificación&#10;                firebaseUser.sendEmailVerification().await()&#10;&#10;                var photoUrl: String? = null&#10;                // Subir imagen a Firebase Storage si la URI no es nula y es válida&#10;                println(&quot;[DEBUG] Usuario autenticado: ${firebaseUser.uid}&quot;)&#10;                println(&quot;[DEBUG] URI: $imageUri, scheme: ${imageUri?.scheme}&quot;)&#10;                if (imageUri != null) {&#10;                    try {&#10;                        photoUrl = uploadProfileImage(imageUri, firebaseUser.uid)&#10;                        println(&quot;[DEBUG] URL de imagen subida: $photoUrl&quot;)&#10;                    } catch (e: Exception) {&#10;                        println(&quot;[ERROR] Error al subir la imagen: ${e.message}&quot;)&#10;                        photoUrl = &quot;&quot;&#10;                    }&#10;                } else {&#10;                    println(&quot;[ERROR] No se seleccionó imagen de perfil.&quot;)&#10;                }&#10;                // 3. Guardar los datos del perfil en Firestore&#10;                val userProfileData = hashMapOf(&#10;                    &quot;username&quot; to uiState.username,&#10;                    &quot;email&quot; to uiState.email,&#10;                    &quot;createdAt&quot; to System.currentTimeMillis(),&#10;                    &quot;isEmailVerified&quot; to false,&#10;                    &quot;photoUrl&quot; to (photoUrl ?: &quot;&quot;)&#10;                )&#10;&#10;                try {&#10;                    firestore.collection(&quot;users&quot;).document(firebaseUser.uid)&#10;                        .set(userProfileData)&#10;                        .await()&#10;                    println(&quot;[DEBUG] Usuario guardado en Firestore: ${firebaseUser.uid}&quot;)&#10;                } catch (e: Exception) {&#10;                    println(&quot;[ERROR] Error al guardar usuario en Firestore: ${e.message}&quot;)&#10;                }&#10;&#10;                uiState = uiState.copy(isLoading = false)&#10;                &#10;                // 4. Navegar a una pantalla que diga &quot;Revisa tu correo para verificar la cuenta&quot;&#10;                _navigationEvent.emit(NavigationEvent.NavigateToEmailVerification)&#10;&#10;            } catch (e: Exception) {&#10;                uiState = uiState.copy(isLoading = false)&#10;                val errorMessage = when (e) {&#10;                    is com.google.firebase.auth.FirebaseAuthUserCollisionException -&gt;&#10;                        &quot;Ya existe una cuenta con este correo electrónico.&quot;&#10;                    is com.google.firebase.auth.FirebaseAuthWeakPasswordException -&gt;&#10;                        &quot;La contraseña es demasiado débil. Debe tener al menos 6 caracteres.&quot;&#10;                    else -&gt;&#10;                        &quot;Ocurrió un error inesperado: ${e.message}&quot;&#10;                }&#10;                uiState = uiState.copy(showDialog = true, dialogMessage = errorMessage)&#10;            }&#10;        }&#10;    }&#10;&#10;    suspend fun uploadProfileImage(imageUri: Uri, userId: String): String? {&#10;        val storageRef = com.google.firebase.storage.FirebaseStorage.getInstance().reference&#10;        val imageRef = storageRef.child(&quot;profile_images/$userId.jpg&quot;)&#10;        imageRef.putFile(imageUri).await() // Subir la imagen primero&#10;        return imageRef.downloadUrl.await().toString()&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>